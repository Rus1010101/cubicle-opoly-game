<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cubicle-opoly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 0.5rem;
            width: 100%;
            max-width: 700px;
            aspect-ratio: 1 / 1;
        }
        .square {
            border: 2px solid #cbd5e1; /* border-slate-300 */
            border-radius: 0.5rem;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0.25rem;
            font-size: 0.6rem; 
            font-weight: 600;
        }
        .square-number {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.6rem;
            font-weight: bold;
            color: rgba(0,0,0,0.2);
        }
        .corner {
            font-size: 0.8rem;
        }
        .pawn {
            width: 1.75rem; /* Adjusted for better grid fit */
            height: 1.75rem;
            border-radius: 9999px;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.2s ease-in-out;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Adjusted for better grid fit */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: white;
            animation: modal-pop 0.3s ease-out forwards;
        }
        @keyframes modal-pop {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="game-wrapper" class="w-full max-w-screen-xl mx-auto flex flex-col lg:flex-row items-center justify-center gap-8">
        <!-- Left Panel: Game Board -->
        <div id="game-board-panel" class="w-full lg:w-auto flex items-center justify-center hidden">
            <div id="board-container" class="relative">
                <div id="game-board" class="board bg-white p-4 rounded-2xl shadow-lg">
                    <!-- Squares generated by JS -->
                </div>
                <div id="pawn-container" class="absolute inset-0 p-4 pointer-events-none">
                     <!-- Pawns generated by JS -->
                </div>
            </div>
        </div>

        <!-- Right Panel: Controls & Info -->
        <div id="controls-panel" class="w-full lg:max-w-sm bg-white p-6 rounded-2xl shadow-lg">
            <!-- Setup Screen -->
            <div id="setup-screen">
                <!-- CHANGED: Added game artwork for a title screen feel -->
                <img src="https://i.postimg.cc/NF2Fbwxr/Chat-GPT-Image-Jul-26-2025-11-15-18-PM.png" alt="Cubicle-opoly Game Art" class="w-full max-w-xs mx-auto rounded-lg mb-6 shadow-md">
                <h1 class="text-3xl font-bold text-slate-900 mb-2 text-center">Cubicle-opoly</h1>
                <p class="text-slate-600 mb-6 text-center">A game of ambition, vulnerability, and surviving pointless meetings.</p>
                <div id="player-count-selection">
                    <label class="text-lg font-semibold mb-2 block text-center">Select Players (2-4):</label>
                    <div class="flex justify-center space-x-2">
                        <button onclick="showNameInputs(2)" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">2</button>
                        <button onclick="showNameInputs(3)" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">3</button>
                        <button onclick="showNameInputs(4)" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">4</button>
                    </div>
                </div>
                <div id="player-name-inputs" class="hidden mt-4">
                    <!-- Name inputs will be generated here -->
                </div>
            </div>

            <!-- Game Info Screen -->
            <div id="game-info" class="hidden">
                <h1 class="text-3xl font-bold text-slate-900 mb-4">Game Status</h1>
                <div id="status-box" class="bg-slate-100 p-4 rounded-lg mb-4 text-center">
                    <p id="status-message" class="font-semibold text-lg text-slate-700"></p>
                </div>
                <div class="mb-4">
                    <h2 class="text-2xl font-semibold mb-2">Scores (IP)</h2>
                    <div id="player-scores" class="space-y-2"></div>
                </div>
                 <div class="mt-6 text-center">
                    <div id="dice-area" class="mb-4">
                        <div id="die-face" class="w-20 h-20 bg-white border-4 border-slate-300 rounded-lg flex items-center justify-center text-4xl font-bold mx-auto mb-2">?</div>
                        <button id="roll-button" onclick="rollDie()" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition">Roll Die</button>
                    </div>
                    <button onclick="goToMainMenu()" class="w-full px-6 py-2 bg-slate-500 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 transition mt-2">Back to Main Menu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
        <div id="modal-content" class="modal-content p-8 rounded-2xl text-center max-w-lg w-full text-slate-800">
            <!-- Modal content generated by JS -->
        </div>
    </div>

    <script>
        // --- GAME DESIGN & STATE ---
        const boardLayout = [
            { gridArea: '1 / 1', type: 'corner', name: 'Performance Review' },
            { gridArea: '1 / 2', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '1 / 3', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '1 / 4', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '1 / 5', type: 'positive', name: 'Free Coffee!', ip: 1 },
            { gridArea: '1 / 6', type: 'negative', name: 'Micromanaging Boss', ip: -2 },
            { gridArea: '1 / 7', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '1 / 8', type: 'corner', name: 'HR Training' },
            { gridArea: '2 / 8', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '3 / 8', type: 'creative', name: 'Pointless Meeting', ip: -1, creativeIp: 3 },
            { gridArea: '4 / 8', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '5 / 8', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '6 / 8', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '7 / 8', type: 'recovery', name: 'System Crash!', ip: -2 },
            { gridArea: '8 / 8', type: 'corner', name: 'Team Offsite' },
            { gridArea: '8 / 7', type: 'recovery', name: 'Deadline Moved Up', ip: -3 },
            { gridArea: '8 / 6', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '8 / 5', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '8 / 4', type: 'creative', name: 'Your Idea Was a Hit!', ip: 3 },
            { gridArea: '8 / 3', 'type': 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '8 / 2', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '8 / 1', type: 'corner', name: 'Re-Org Chaos!' },
            { gridArea: '7 / 1', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '6 / 1', type: 'creative', name: 'Surprise Team Lunch!', ip: 2, creativeIp: 3 },
            { gridArea: '5 / 1', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '4 / 1', type: 'fun', name: 'TBA Fun', ip: 2 },
            { gridArea: '3 / 1', type: 'vulnerable', name: 'Real Issue', ip: 5 },
            { gridArea: '2 / 1', type: 'negative', name: 'Took Credit for Your Work', ip: -2 },
        ];
        
        const prompts = {
            fun: [
                "Pitch a new office holiday. What is it and how is it celebrated?",
                "You can only communicate using emojis for the next round. Good luck.",
                "Give a one-minute acceptance speech for a 'Dundie Award' you just won.",
                "Invent a new, completely useless feature for Microsoft Teams or Slack.",
                "Describe the plot of the last movie you watched, but replace the main character with your boss.",
                "Sing the chorus of your favorite karaoke song.",
                "If our company was an animal, what would it be and why?",
                "Redesign the company logo in 30 seconds on a piece of paper (or describe it).",
                "What's your most useless secret talent? Demonstrate it if possible.",
                "Create a new, mandatory team-building exercise that is delightfully awkward.",
                "Tell a story about a workplace misunderstanding that turned out to be funny.",
                "If you had to create a new office-themed Olympic sport, what would it be?",
                "Give a dramatic reading of the last email you sent.",
                "What would be the title of your work-life memoir?",
                "You've been promoted to CEO for the day. What's your first decree?",
                "Start your next sentence with 'According to the prophecy...'",
                "Describe your job to a 5-year-old.",
                "What's a weird but effective productivity hack you have?",
                "Create a new corporate slogan for our team.",
                "If you could have any fictional character as a coworker, who would it be and why?",
                "Do your best impression of a dial-up modem connecting to the internet.",
                "What was your dream job as a child?",
                "If you could add one weirdly specific channel to the team's chat, what would it be called?",
                "Describe a time you 'faked it till you made it'.",
                "What song best describes your work ethic?",
                "You can have lunch with any three people, living or dead. Who are they and what do you serve?",
                "What's the most creative excuse you've ever used (or wanted to use) for being late?",
                "If you had to be stuck in a meeting with one person from this group for 24 hours, who would it be and why?",
                "Propose a toast to the person on your left.",
                "What's the weirdest thing you've ever eaten for lunch at your desk?",
                "If your computer could talk, what's the first thing it would say to you?",
                "What's a small, simple thing that brings you joy during the workday?",
                "You're a superhero. What's your name and what's your mundane, office-related power?",
                "If you could only eat one food for the rest of your career, what would it be?",
                "What's the most embarrassing song on your workout playlist?",
                "Create a haiku about your current role.",
                "If you could automate one part of your job, what would it be?",
                "What is a professional 'hill you will die on'?"
            ],
            vulnerable: [
                "Describe a time you had to give difficult feedback to a colleague. How did you approach it?",
                "Recall a time you received feedback that was hard to hear but ultimately helpful. What was it?",
                "What is one thing your 'future self' would tell your 'current self' about navigating your career?",
                "Describe a time you disagreed with a team decision. Did you speak up? Why or why not?",
                "How do you challenge a process or an idea you believe is flawed, especially when it's supported by leadership?",
                "Share a story about a time you had to ask for help on a project. What made it challenging or easy?",
                "What's a professional assumption you once held that has since been proven wrong?",
                "Describe a time you felt 'out of your depth' at work. How did you handle it?",
                "Talk about a time you had to navigate a difficult conversation with your manager.",
                "What is a 'soft skill' (e.g., communication, empathy) you are actively trying to improve?",
                "Share an example of a time you helped a teammate who was struggling.",
                "What does 'psychological safety' at work mean to you, and have you experienced it?",
                "Describe a time you had to say 'no' to a request at work. What was the situation?",
                "What is a boundary you've had to set at work to protect your well-being?",
                "Share a time you witnessed someone else handle a difficult situation with grace. What did you learn?",
                "What is one thing you wish you had known at the start of your career?",
                "Describe a time you felt your contribution was overlooked. How did it impact you?",
                "How do you prefer to receive recognition for your work? (Public praise, private thank you, etc.)",
                "What is a professional failure you experienced, and what was the most valuable lesson you learned from it?",
                "Talk about a time you had to build trust with a new team or colleague.",
                "What is one aspect of your work that gives you a deep sense of purpose?",
                "Describe a time you had to adapt to a major change at work (e.g., new role, new team, re-org).",
                "How do you approach a conversation when you know you need to deliver bad news?",
                "What is a professional value you hold that you are unwilling to compromise?",
                "Share a time you successfully mediated a disagreement between colleagues.",
                "What is your personal strategy for avoiding burnout?",
                "Describe a time you felt imposter syndrome. How do you talk to yourself in those moments?",
                "What is one thing you would change about how your team communicates?",
                "Talk about a mentor or colleague who has had a significant positive impact on your career.",
                "What is a professional risk you took that paid off?",
                "How do you build consensus when stakeholders have conflicting priorities?",
                "Describe a situation where you had to 'manage up' to help your manager and team succeed."
            ],
            creative: { "Pointless Meeting": "Before losing 1 IP, describe one thing that would make this meeting *not* pointless.", "Your Idea Was a Hit!": 'Describe your "hit" idea in one sentence.', "Surprise Team Lunch!": 'All players gain 2 IP! As the person who landed here, describe your ideal impromptu "Surprise Team Lunch".' },
            recovery: { 
                "System Crash!": "A major system has crashed. What is the correct procedure to report it?",
                "Deadline Moved Up": "A project deadline was suddenly moved up. How do you respond professionally to handle the pressure?"
            }
        };

        let availablePrompts = {};
        let players = [];
        let currentPlayerIndex = 0;
        let totalLaps = 2;
        const playerColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308'];
        const playerPawns = ['üè°', 'üîë', 'üè¶', 'üìà'];

        // --- DOM ELEMENTS ---
        const setupScreen = document.getElementById('setup-screen');
        const gameInfo = document.getElementById('game-info');
        const gameBoardPanel = document.getElementById('game-board-panel');
        const controlsPanel = document.getElementById('controls-panel');
        const gameBoard = document.getElementById('game-board');
        const pawnContainer = document.getElementById('pawn-container');
        const statusMessage = document.getElementById('status-message');
        const playerScoresEl = document.getElementById('player-scores');
        const dieFace = document.getElementById('die-face');
        const rollButton = document.getElementById('roll-button');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const playerCountSelection = document.getElementById('player-count-selection');
        const playerNameInputs = document.getElementById('player-name-inputs');

        // --- SOUND DESIGN ---
        let hopSynth, diceSynth;

        function setupSounds() {
            if (typeof Tone !== 'undefined') {
                if (!hopSynth) hopSynth = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
                if (!diceSynth) diceSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.15, sustain: 0 } }).toDestination();
            }
        }
        function playHopSound() { if (hopSynth) hopSynth.triggerAttackRelease("C2", "8n", Tone.now()); }
        function playDiceSound() {
            if (diceSynth) {
                const now = Tone.now();
                diceSynth.triggerAttackRelease("0.05", now);
                diceSynth.triggerAttackRelease("0.05", now + 0.07);
                diceSynth.triggerAttackRelease("0.05", now + 0.14);
            }
        }

        // --- SETUP ---
        function showNameInputs(numPlayers) {
            playerCountSelection.classList.add('hidden');
            playerNameInputs.classList.remove('hidden');
            playerNameInputs.innerHTML = '';
            for (let i = 0; i < numPlayers; i++) {
                playerNameInputs.innerHTML += `<div class="mb-2"><label for="player-name-${i+1}" class="font-semibold">Player ${i+1} Name:</label><input type="text" id="player-name-${i+1}" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md text-slate-800" placeholder="Enter name..."></div>`;
            }
            playerNameInputs.innerHTML += `<div class="flex space-x-2 mt-4"><button onclick="backToPlayerCount()" class="w-1/3 py-3 bg-slate-500 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 transition">Back</button><button onclick="setupGame(${numPlayers})" class="w-2/3 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">Start Game</button></div>`;
        }

        function backToPlayerCount() {
            playerNameInputs.classList.add('hidden');
            playerCountSelection.classList.remove('hidden');
        }

        function setupGame(numPlayers) {
            setupSounds();
            availablePrompts.fun = [...prompts.fun].sort(() => Math.random() - 0.5);
            availablePrompts.vulnerable = [...prompts.vulnerable].sort(() => Math.random() - 0.5);
            players = [];
            for (let i = 0; i < numPlayers; i++) {
                const nameInput = document.getElementById(`player-name-${i+1}`);
                players.push({ id: i + 1, name: nameInput.value || `Player ${i+1}`, pawn: playerPawns[i], color: playerColors[i], position: 0, ip: 0, laps: 0, stuck: 0, finished: false });
            }
            currentPlayerIndex = 0;
            totalLaps = 2;
            
            // Transition from setup to game view
            setupScreen.classList.add('hidden');
            gameInfo.classList.remove('hidden');
            gameBoardPanel.classList.remove('hidden');
            controlsPanel.classList.remove('lg:max-w-sm'); // Allow panel to grow
            controlsPanel.classList.add('lg:max-w-md'); // A slightly larger max-width for game info
            
            renderBoard();
            renderPawns();
            updateScores();
            updateStatus();
        }

        // --- RENDERING ---
        function renderBoard() {
            gameBoard.innerHTML = '';
            boardLayout.forEach((s, i) => {
                const square = document.createElement('div');
                square.id = `square-${i}`;
                square.style.gridArea = s.gridArea;
                square.className = `square ${s.type === 'corner' ? 'corner' : ''}`;
                let bgColor = 'bg-white';
                if (s.type === 'negative' || s.type === 'recovery') bgColor = 'bg-red-200 text-red-800';
                if (s.type === 'positive' || s.name === 'Promotion!') bgColor = 'bg-green-200 text-green-800';
                if (s.type === 'vulnerable') bgColor = 'bg-blue-200 text-blue-800';
                if (s.type === 'fun') bgColor = 'bg-yellow-200 text-yellow-800';
                if (s.type === 'creative') bgColor = 'bg-purple-200 text-purple-800';
                if (s.type === 'corner') bgColor = 'bg-slate-700 text-white';
                if (s.type === 'blank') bgColor = 'bg-slate-50';
                square.classList.add(...bgColor.split(' '));
                square.innerHTML = `<div class="square-number">${i + 1}</div><span>${s.name}</span>`;
                gameBoard.appendChild(square);
            });
            const center = document.createElement('div');
            center.style.gridArea = '2 / 2 / 8 / 8';
            center.className = 'bg-slate-200 rounded-lg overflow-hidden shadow-inner';
            center.innerHTML = `<img src="https://i.postimg.cc/NF2Fbwxr/Chat-GPT-Image-Jul-26-2025-11-15-18-PM.png" alt="Game Logo" class="w-full h-full object-cover" onerror="this.onerror=null;this.parentElement.innerHTML='<h2 class=\\'text-4xl font-bold text-slate-700 p-4\\'>Cubicle-opoly</h2>';">`;
            gameBoard.appendChild(center);
        }

        function renderPawns() {
            pawnContainer.innerHTML = '';
            players.forEach(player => {
                const pawn = document.createElement('div');
                pawn.id = `pawn-${player.id}`;
                pawn.className = 'pawn';
                pawn.style.backgroundColor = player.color;
                pawn.innerText = player.pawn;
                pawnContainer.appendChild(pawn);
                updatePawnPosition(player.id, player.position);
            });
        }
        
        function updatePawnPosition(playerId, position) {
            const pawn = document.getElementById(`pawn-${playerId}`);
            if (!pawn) return;
            const squareEl = document.getElementById(`square-${position}`);
            if (!squareEl) return;

            const containerRect = pawnContainer.getBoundingClientRect();
            const squareRect = squareEl.getBoundingClientRect();
            
            const playersOnSquare = players.filter(p => p.position === position);
            const pawnIndex = playersOnSquare.findIndex(p => p.id === playerId);

            // Arrange pawns in a 2x2 grid within the square
            const numCols = playersOnSquare.length > 1 ? 2 : 1;
            const pawnX = (pawnIndex % numCols);
            const pawnY = Math.floor(pawnIndex / numCols);
            
            const pawnWidth = pawn.offsetWidth;
            const pawnHeight = pawn.offsetHeight;

            const squareInnerWidth = squareEl.clientWidth;
            const squareInnerHeight = squareEl.clientHeight;

            // Center the grid of pawns within the square
            const gridWidth = numCols * pawnWidth;
            const gridHeight = (Math.ceil(playersOnSquare.length / numCols)) * pawnHeight;
            
            const baseLeft = (squareInnerWidth - gridWidth) / 2;
            const baseTop = (squareInnerHeight - gridHeight) / 2;

            const left = (squareRect.left - containerRect.left) + baseLeft + (pawnX * pawnWidth);
            const top = (squareRect.top - containerRect.top) + baseTop + (pawnY * pawnHeight);

            pawn.style.left = `${left}px`;
            pawn.style.top = `${top}px`;
        }


        function updateScores() {
            playerScoresEl.innerHTML = '';
            players.forEach(player => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = `p-3 rounded-lg flex items-center transition-all duration-300 ${player.id - 1 === currentPlayerIndex && !player.finished ? 'bg-yellow-200' : 'bg-slate-100'}`;
                scoreDiv.innerHTML = `<div class="w-8 h-8 rounded-full text-white text-xl flex items-center justify-center mr-3" style="background-color: ${player.color}">${player.pawn}</div><span class="font-semibold">${player.name} (Lap ${player.laps})</span><span class="ml-auto font-bold text-slate-700">${player.ip} IP</span>`;
                playerScoresEl.appendChild(scoreDiv);
            });
        }

        function updateStatus() {
            const player = players[currentPlayerIndex];
            statusMessage.innerText = `${player.name}'s Turn`;
            rollButton.disabled = player.stuck > 0 || player.finished;
            dieFace.innerText = '?';
            if (player.stuck > 0) {
                 setTimeout(() => {
                    player.stuck--;
                    showModalMessage(`<h2>Stuck in Training!</h2><p class="my-4">${player.name} misses a turn.</p>`, true);
                }, 500);
            } else if (player.finished) {
                showModalMessage(`<h2>Finished!</h2><p class="my-4">${player.name} is waiting for other players to finish.</p>`, true);
            }
        }
        
        // --- GAME FLOW ---
        function rollDie() {
            rollButton.disabled = true;
            playDiceSound();
            let animationInterval = setInterval(() => { dieFace.innerText = Math.floor(Math.random() * 6) + 1; }, 100);
            setTimeout(() => {
                clearInterval(animationInterval);
                const roll = Math.floor(Math.random() * 6) + 1;
                dieFace.innerText = roll;
                const player = players[currentPlayerIndex];
                movePawnStepByStep(player, roll).then(() => { executeSquareAction(player); });
            }, 1000);
        }

        function movePawnStepByStep(player, steps) {
            return new Promise(resolve => {
                let currentSteps = 0;
                const hop = () => {
                    if (currentSteps >= steps) { resolve(); return; }
                    player.position = (player.position + 1) % boardLayout.length;
                    if (player.position === 0) {
                        player.laps++;
                        player.ip += 5;
                        const playersAhead = players.filter(p => (p.laps * 100 + p.position) > (player.laps * 100 + player.position));
                        player.ip += playersAhead.length * 2;
                        updateScores();
                    }
                    
                    const playersOnOldSquare = players.filter(p => p.position === (player.position - 1 + boardLayout.length) % boardLayout.length);
                    playersOnOldSquare.forEach(p => updatePawnPosition(p.id, p.position));

                    const playersOnNewSquare = players.filter(p => p.position === player.position);
                    playersOnNewSquare.forEach(p => updatePawnPosition(p.id, p.position));
                    
                    playHopSound();
                    currentSteps++;
                    setTimeout(hop, 250);
                };
                hop();
            });
        }

        function executeSquareAction(player) {
             if (player.laps >= totalLaps) {
                player.finished = true;
                const finishers = players.filter(p => p.finished);
                if (finishers.length === 1) player.ip += 5;
                if (players.every(p => p.finished)) { promptExtendGame(); return; }
            }
            const square = boardLayout[player.position];
            let modalTitle = `Landed on: ${square.name}`;
            if (square.type === 'negative' || square.type === 'positive' || square.name === 'Promotion!') {
                player.ip += square.ip;
                showModalMessage(`<h2>${modalTitle}</h2><p class="my-4">Your IP has been adjusted by ${square.ip}.</p>`, true);
            } else if (square.name === 'HR Training') {
                player.stuck = 1;
                showModalMessage(`<h2>${modalTitle}</h2><p class="my-4">You're stuck in Mandatory HR Training! Lose your next turn.</p>`, true);
            } else if (square.name === 'Re-Org Chaos!') {
                player.ip -= 5;
                const hrTrainingIndex = boardLayout.findIndex(s => s.name === 'HR Training');
                player.position = hrTrainingIndex;
                player.stuck = 1;
                // Update all pawns on the old square and the new one
                players.forEach(p => updatePawnPosition(p.id, p.position));
                showModalMessage(`<h2>${modalTitle}</h2><p class="my-4">A chaotic re-org! Lose 5 IP and go directly to HR Training. Lose your next turn.</p>`, true);
            } else if (square.type === 'vulnerable' || square.type === 'fun' || square.type === 'creative') {
                let prompt = '';
                if (square.type === 'fun' || square.type === 'vulnerable') {
                    if (availablePrompts[square.type].length === 0) availablePrompts[square.type] = [...prompts[square.type]].sort(() => Math.random() - 0.5);
                    prompt = availablePrompts[square.type].pop();
                } else {
                    prompt = prompts.creative[square.name];
                }
                let ipReward = square.ip;
                if (square.type === 'creative' && square.name === 'Surprise Team Lunch!') {
                    players.forEach(p => { if (p.id !== player.id) p.ip += square.ip });
                    ipReward = square.creativeIp;
                } else if (square.type === 'creative') {
                    ipReward = square.ip;
                }
                showTaskModal(square, prompt, ipReward);
            } else if (square.type === 'recovery') {
                showRecoveryTaskModal(square);
            } else {
                nextTurn();
            }
        }
        
        function showTaskModal(square, prompt, ipReward) {
            let modalTitle = `Landed on: ${square.name}`;
            let modalBody = `<p class="text-lg mb-6">"${prompt}"</p>`;
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">${modalTitle}</h2><div>${modalBody}</div><div class="flex justify-center space-x-4 mt-6"><button onclick="handleTaskChoice(true, ${ipReward})" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">Complete Task (+${ipReward} IP)</button><button onclick="handleTaskChoice(false, 0)" class="px-6 py-3 bg-slate-500 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 transition">Skip Task (+0 IP)</button></div>`;
            modal.classList.remove('hidden');
        }

        function showRecoveryTaskModal(square) {
            const prompt = prompts.recovery[square.name];
            const ipPenalty = square.ip;
            let modalTitle = `Setback: ${square.name}`;
            let modalBody = `<p class="text-lg mb-6">"${prompt}"</p><p class="text-sm text-slate-500">Can you handle it correctly to avoid the penalty?</p>`;
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">${modalTitle}</h2><div>${modalBody}</div><div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                <button onclick="handleRecoveryChoice(true, ${ipPenalty})" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">Yes, I followed procedure! (Avoids Penalty)</button>
                <button onclick="handleRecoveryChoice(false, ${ipPenalty})" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition">No, I'll take the hit (${ipPenalty} IP)</button>
            </div>`;
            modal.classList.remove('hidden');
        }

        function handleTaskChoice(completed, ipReward) {
            if (completed) players[currentPlayerIndex].ip += ipReward;
            modal.classList.add('hidden');
            nextTurn();
        }

        function handleRecoveryChoice(succeeded, ipPenalty) {
            if (!succeeded) {
                players[currentPlayerIndex].ip += ipPenalty;
            }
            modal.classList.add('hidden');
            nextTurn();
        }

        function showModalMessage(content, autoClose = false) {
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
            if (autoClose) {
                setTimeout(() => {
                    modal.classList.add('hidden');
                    nextTurn();
                }, 2500);
            }
        }

        function nextTurn() {
            updateScores();
            let nextPlayerIndex = (currentPlayerIndex + 1) % players.length;
            while(players[nextPlayerIndex].finished && nextPlayerIndex !== currentPlayerIndex) {
                nextPlayerIndex = (nextPlayerIndex + 1) % players.length;
            }
            if (players.every(p => p.finished)) { promptExtendGame(); return; }
            currentPlayerIndex = nextPlayerIndex;
            updateStatus();
        }

        function promptExtendGame() {
            modalContent.innerHTML = `<h2 class="text-3xl font-bold mb-4">Continue Playing?</h2><p class="text-lg mb-6">All players have completed ${totalLaps} laps. Would you like to extend the game?</p><div class="flex items-center justify-center space-x-4 mb-6"><label for="lap-selector" class="font-semibold">Add Laps:</label><input type="number" id="lap-selector" min="1" max="5" value="1" class="w-20 px-3 py-2 border border-slate-300 rounded-md text-slate-800"></div><div class="flex justify-center space-x-4"><button onclick="extendGame()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">Yes, Continue!</button><button onclick="endGame()" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition">No, End Game</button></div>`;
            modal.classList.remove('hidden');
        }

        function extendGame() {
            const lapSelector = document.getElementById('lap-selector');
            const additionalLaps = parseInt(lapSelector.value, 10) || 1;
            totalLaps += additionalLaps;
            players.forEach(p => p.finished = false);
            modal.classList.add('hidden');
            nextTurn();
        }

        function endGame() {
            const winner = players.reduce((prev, current) => (prev.ip > current.ip) ? prev : current);
            modalContent.innerHTML = `<h2 class="text-4xl font-bold mb-4">üèÜ Game Over! üèÜ</h2><p class="text-2xl font-semibold text-blue-600 mb-6">The winner is ${winner.name} with ${winner.ip} Insight Points!</p><button onclick="goToMainMenu()" class="w-full px-8 py-4 bg-indigo-600 text-white font-bold text-xl rounded-lg shadow-md hover:bg-indigo-700 transition">Play Again</button>`;
            modal.classList.remove('hidden');
        }

        function goToMainMenu() {
            // Transition from game view back to setup
            gameInfo.classList.add('hidden');
            gameBoardPanel.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            controlsPanel.classList.remove('lg:max-w-md');
            controlsPanel.classList.add('lg:max-w-sm');

            modal.classList.add('hidden');
            playerCountSelection.classList.remove('hidden');
            playerNameInputs.classList.add('hidden');
            players = [];
            currentPlayerIndex = 0;
        }

        // Ensure pawns are repositioned on window resize
        window.addEventListener('resize', () => {
            if (players.length > 0) {
                players.forEach(p => updatePawnPosition(p.id, p.position));
            }
        });

    </script>
</body>
</html>